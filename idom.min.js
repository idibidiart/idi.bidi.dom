/* idi.bidi.dom 
* 
* DOM Anti-Templating 
*
* Copyright (c) Marc Fawzi 2012
* 
* http://javacrypt.wordpress.com
*
* BSD License 
* 
* derived from NattyJS v0.08: an open source precursor by the same author 
*
*/
var idom={};idom.user={};idom.version="0.01";idom.regex=/(idom\$\w+)/g;idom.regexLength=5;idom.initRegEx=/(i\$\w+)/g;idom.initRegexLength=2;idom.internal={};idom.internal.cache={};idom.init=function(c){if(idom.internal.initDone){return}if(!Element||!NodeList||!String){var f=new Error;f.message="This browser is not supported: some basic Javascript objects are missing";throw f.message+"\n"+f.stack}if(c){document.documentElement.innerHTML=document.documentElement.innerHTML._idomMapValues(c,true)}var b=document.querySelectorAll("[idom-node-id]");var e=Array.prototype.slice.call(b,0);b=null;for(var h=0;h<e.length;h++){var d=e[h];var g=d.getAttribute("idom-node-id");if(idom.internal.cache[g]){throw new Error("idom-node-id is in use by another Node")}if(!g){throw new Error("Node must have idom-node-id attribute set to a non-empty string value")}if(g.match(idom.regex)){throw new Error("idom-node-id must not contain a special variable. ")}if(d.tagName.toLowerCase()=="iframe"){throw new Error("iframe is not allowed as Node. you must load and use idom from within the iframe")}if(d.children.length!=1){throw new Error("at the time of caching, node must contain just one child as Node Prototype.you may use a div to encapsulate multiple descendants.")}var a=d.getElementsByNodeType(8);if(a.length){for(var h=0;h<a.length;h++){if(a[i].textContent.match(/(@idom)([\s+])(\w+)/)[3]){throw new Error("Node must not have any @idom comment nodes (may only use within the Node Prototype)")}}}if(d.innerHTML.match(/(idom-node-id)/)){throw new Error("Node must not have any descendants with idom-node-id (reserved for the Node itself). you may dynamically link other Nodes by inserting <!-- @idom [the idom-node-id for node you wish to nest without the brackets] --> anywhere inside the Node Prototype")}if(d.getAttribute("id")){throw new Error("Node should not have an 'id' attribute (instead, set nodeSelector or nodeState in options and use document.querySelector with '[idom-selector=someString]' or '[idom-state=someString]')")}if(d.children[0].getAttribute("id")){throw new Error("Node Prototype should not have an 'id' attribute (instead, set ownSelector or ownState in options and use document.querySelector with '[idom-selector=someString]' or '[idom-state=someString]')")}if(d.getAttribute("idom-state")||d.getAttribute("idom-selector")){throw new Error("at time of caching, node should not have any idom-generated attributes")}if(d.innerHTML.match(/(idom-selector)/)||d.innerHTML.match(/(idom-state)/)){throw new Error("at time of caching, node's innerHTML must not contain any idom-generated attributes")}idom.internal.cache[g]=d.innerHTML}idom.internal.initDone=true};String.prototype._idomMapValues=String.prototype._idomMapValues||function(){var c=arguments[0];var b=arguments[1];var a,h;var f=idom.internal.initDone?idom.regex:idom.initRegEx;var j=idom.internal.initDone?idom.regexLength:idom.initRegexLength;try{a=JSON.stringify(c)}catch(g){h=true}if(h||a.match(/[\{]{2,}|[\[]/)){var d=new Error;d.message="Invalid data: use simple JSON: {someKey: 'value', anotherKey: 5, yetAnotherKey: 'anotherValue'}";throw d.message+"\n"+d.stack}else{if(a.match(idom.regex)){var d=new Error;d.message="Invalid data: idom node variables found in json";throw d.message+"\n"+d.stack}}if(!b){return this.replace(idom.regex,function(e){if(c[e.substr(idom.regexLength)]){return c[e.substr(idom.regexLength)]}else{return""}})}else{return this.replace(idom.initRegEx,function(e){if(c[e.substr(idom.initRegexLength)]){return c[e.substr(idom.initRegexLength)]}else{return""}})}};Element.prototype.nextSiblingElement=Element.prototype.nextSiblingElement||function(){var a=this;do{a=a.nextSibling}while(a&&a.nodeType!=1);return a};Element.prototype.previousSiblingElement=Element.prototype.previousSiblingElement||function(){var a=this;do{a=a.previousSibling}while(a&&a.nodeType!=1);return a};Element.prototype.getElementsByNodeType=Element.prototype.getElementsByNodeType||function(){var e=this;var c=arguments[0];var b=arguments[1];var f=e.childNodes;var a=[];for(var d=0;d<f.length;d++){if(f[d].nodeType==Number(c)){a.push(f[d])}if(b&&(f[d].nodeType==1)){a=a.concat(f[d].getElementsByNodeType(c,b))}}return a};Object.prototype.forEachExec=Object.prototype.forEachExec||function(){var b=Array.prototype.slice.call(this,0);if(!b.length){var c=new Error;c.message="object must be indexable";throw c.message+"\n"+c.stack}str=arguments[0];var a=new Function("el","el."+str);try{a(b[0])}catch(c){throw"invalid exec: "+c.message+"\n"+c.stack}for(var d=1;d<b.length;d++){a(b[d])}};Element.prototype.idom$=Element.prototype.idom$||function(){if(!idom.internal.initDone){var g=new Error;g.message="you must run idom.init() from window.onload or $(document).ready before invoking .idom$ methods";throw g.message+"\n"+g.stack}var j=this.getAttribute("idom-node-id");if(!idom.internal.cache[j]){var g=new Error;g.message="node was not cached";throw g.message+"\n"+g.stack}var q=arguments[0];var d=arguments[1];if(!(arguments[0])){var g=new Error;g.message="required argument: data (json)";throw g.message+"\n"+g.stack}if(d){var l,k;try{k=JSON.stringify(d)}catch(r){l=true}if(l||k.match(/[\{]{2,}|[\[]/)){var g=new Error;g.message="Invalid options: use simple JSON. {someKey: 'value', anotherKey: 5, yetAnotherKey: 'anotherValue'}";throw g.message+"\n"+g.stack}else{if(k.match(idom.regex)){var g=new Error;g.message="Invalid options: idom node variables found in options";throw g.message+"\n"+g.stack}}}if(this.innerHTML==idom.internal.cache[j]||!this.children||!d||d=={}||(d&&!(d.targetSelector||d.targetState||d.mode))){if(d){if(d.targetSelector){if(this.innerHTML==idom.internal.cache[j]||!this.children){var g=new Error;g.message="Invalid option: targetSelector cannot be applied: this Node currently has no populated instances of its Node Prototype";throw g.message+"\n"+g.stack}}}this.innerHTML=idom.internal.cache[j]._idomMapValues(q);if(d){c(this.children[0]);t(this)}f(this.children[0]);return}else{if(d){var h=[],s=[],u,p,b,a;if(d.targetSelector&&!d.targetState){h=this.querySelectorAll("[idom-selector="+d.targetSelector+"]");if(!h.length){var g=new Error;g.message="Invalid option: targetSelector does not match idom-selector in any instance of the Node Prototype";throw g.message+"\n"+g.stack}}else{if(!d.targetSelector&&d.targetState){h=this.querySelectorAll("[idom-state="+d.targetState+"]");if(!h.length){var g=new Error;g.message="Invalid option: targetState does not match idom-state in any instance of the Node Prototype";throw g.message+"\n"+g.stack}}else{if(d.targetSelector&&d.targetState){h=this.querySelectorAll("[idom-selector="+d.targetSelector+"][idom-state="+d.targetState+"]");if(!h.length){var g=new Error;g.message="Invalid option: 'targetSelector AND targetState' do not match idom-selector/idom-state combination in any instance of the Node Prototype";throw g.message+"\n"+g.stack}}}}if(d.targetSelector||d.targetState||d.mode=="append"||d.mode=="prepend"){u=this.children[0].tagName;p=idom.internal.cache[j]._idomMapValues(q);b=document.createElement(u);b.innerHTML=p;a=document.createDocumentFragment();a.appendChild(b.children[0])}switch(d.mode){case null:case"":case"replace":if(d.targetSelector||d.targetState){if(h.length>1){for(var o=0;o<h.length;o++){this.insertBefore(a.cloneNode(true),h[o]);s[o]=h[o].previousSiblingElement();this.removeChild(h[o]);f(s[o]);c(s[o])}}else{this.insertBefore(a.cloneNode(true),h[0]);s[0]=h[0].previousSiblingElement();this.removeChild(h[0]);f(s[0]);c(s[0])}}else{this.innerHTML=idom.internal.cache[j]._idomMapValues(q);s[0]=this.children[0];f(s[0]);c(s[0])}break;case"append":if(d.targetSelector||d.targetState){if(h.length>1){var m=h[h.length-1];this.insertBefore(a.cloneNode(true),m.nextSiblingElement());s[0]=m.nextSiblingElement();f(s[0]);c(s[0])}else{var m=h[0];this.insertBefore(a.cloneNode(true),m.nextSiblingElement());s[0]=m.nextSiblingElement();f(s[0]);c(s[0])}}else{this.appendChild(a.cloneNode(true));s[0]=this.children[this.children.length-1];f(s[0]);c(s[0])}break;case"prepend":if(d.targetSelector||d.targetState){this.insertBefore(a.cloneNode(true),h[0]);s[0]=h[0].previousSiblingElement();f(s[0]);c(s[0])}else{this.insertBefore(a.cloneNode(true),this.children[0]);s[0]=this.children[0];f(s[0]);c(s[0])}break;default:var g=new Error;g.message="invalid or misspelled value for mode";throw g.message+"\n"+g.stack}t(this);a=null}}function t(e){if(d.nodeSelector){e.setAttribute("idom-selector",d.nodeSelector)}if(d.nodeState){e.setAttribute("idom-state",d.nodeState)}}function c(e){if(d.ownSelector){e.setAttribute("idom-selector",d.ownSelector)}if(d.ownState){e.setAttribute("idom-state",d.ownState)}}function f(z){var e=z.getElementsByNodeType(8,true);var B="";if(e.length){for(var x=0;x<e.length;x++){B=e[x].textContent.match(/(@idom)([\s+])(\w+)/)[3];if(B){if(!idom.internal.cache[B]){var A=new Error;A.message="Node Prototype contains a Linked Node reference to a Node that was not cached";throw A.message+"\n"+A.stack}}var v=e[x].parentNode.insertBefore(document.querySelector("[idom-node-id="+B+"]").cloneNode(true),e[x]);v.parentNode.removeChild(e[x]);v.removeAttribute("idom-node-id");var w=v.children[0].getAttribute("idom-state")||"";var C=v.children[0].getAttribute("idom-selector")||"";if(w){v.children[0].setAttribute("idom-state",w+"_linked")}if(C){v.children[0].setAttribute("idom-selector",C+"_linked")}var D=v.getAttribute("idom-state")||"";var y=v.getAttribute("idom-selector")||"";if(D){v.setAttribute("idom-state",D+"_linked")}if(y){v.setAttribute("idom-selector",y+"_linked")}}}}};Element.prototype.idom$isPopulated=Element.prototype.idom$isPopulated||function(){if(!idom.internal.initDone){var a=new Error;a.message="you must run idom.init() from window.onload or $(document).ready before invoking .idom$ methods";throw a.message+"\n"+a.stack}var b=this.getAttribute("idom-node-id");if(!idom.internal.cache[b]){var a=new Error;a.message="node was not cached";throw a.message+"\n"+a.stack}if(this.innerHTML==idom.internal.cache[b]||!this.children){return false}return true};Element.prototype.idom$delete=Element.prototype.idom$delete||function(){if(!idom.internal.initDone){var f=new Error;f.message="you must run idom.init() from window.onload or $(document).ready before invoking .idom$ methods";throw f.message+"\n"+f.stack}var a=this.getAttribute("idom-node-id");if(!idom.internal.cache[a]){var f=new Error;f.message="node was not cached";throw f.message+"\n"+f.stack}if(!this.children){return}var k=arguments[0];var g,h;if(k){try{g=JSON.stringify(k)}catch(j){h=true}if(h||g.match(/[\{]{2,}|[\[]/)){var f=new Error;f.message="Invalid options: use simple JSON. {someKey: 'value', anotherKey: 5, yetAnotherKey: 'anotherValue'}";throw f.message+"\n"+f.stack}else{if(g.match(idom.regex)){var f=new Error;f.message="Invalid data: idom node variables found in options";throw f.message+"\n"+f.stack}}var c=[];if(k.targetSelector){if(k.targetSelector&&!k.targetState){var d=document.querySelector("[idom-node-id="+a+"]");for(var b=0;b<d.children.length;b++){if(d.children[b].getAttribute("idom-selector")==k.targetSelector){c.push(d.children[b])}}if(!c){var f=new Error;f.message="Invalid option: targetSelector does not match idom-selector in any instance of the Node Prototype";throw f.message+"\n"+f.stack}}else{if(!k.targetSelector&&k.targetState){var d=document.querySelector("[idom-node-id="+a+"]");for(var b=0;b<d.children.length;b++){if(d.children[b].getAttribute("idom-state")==k.targetState){c.push(d.children[b])}}if(!c){var f=new Error;f.message="Invalid option: targetSelector does not match idom-selector in any instance of the Node Prototype)";throw f.message+"\n"+f.stack}}else{if(k.targetSelector&&k.targetState){var d=document.querySelector("[idom-node-id="+a+"]");for(var b=0;b<d.children.length;b++){if(d.children[b].getAttribute("idom-state")==k.targetState&&d.children[b].getAttribute("idom-selector")==k.targetSelector){c.push(d.children[b])}}if(!c){var f=new Error;f.message="Invalid option: targetSelector does not match idom-selector in any instance of the Node Prototypee";throw f.message+"\n"+f.stack}}}}for(var b=0;b<c.length;b++){this.removeChild(c[b])}}if(k.nodeState){this.setAttribute("idom-state",k.nodeState)}if(k.nodeSelector){this.setAttribute("idom-selector",k.nodeSelector)}}else{this.innerHTML=""}};if(typeof(jQuery)=="function"){(function(a){a.fn.idom$=function(){var b=this.get(0)};a.fn.idom$isPopulated=function(){var b=this.get(0)};a.fn.idom$delete=function(){var b=this.get(0)}})(jQuery)};