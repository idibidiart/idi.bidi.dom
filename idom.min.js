/* idi.bidi.dom 
* 
* DOM Anti-Templating 
*
* Copyright (c) Marc Fawzi 2012
* 
* http://javacrypt.wordpress.com
*
* BSD License 
* 
* derived from NattyJS v0.08: an open source precursor by the same author 
*
*/
var idom={};idom.user={};idom.version="0.01";idom.regex=/(idom\$\w+)/g;idom.regexLength=5;idom.initRegEx=/(i\$\w+)/g;idom.initRegexLength=2;idom.internal={};idom.internal.cache={};idom.init=function(j){if(idom.internal.initDone){return}if(!Element||!NodeList||!String){var e=new Error;e.message="This browser is not supported: some basic Javascript objects are missing";throw e.message+"\n"+e.stack}if(j){document.documentElement.innerHTML=document.documentElement.innerHTML._idomMapValues(j,true)}var f=document.querySelectorAll("[idom-node-id]");var d=Array.prototype.slice.call(f,0);f=null;for(var c=0;c<d.length;c++){var b=d[c];var a=b.getAttribute("idom-node-id");if(idom.internal.cache[a]){throw new Error("idom-node-id is in use by another Node")}if(!a){throw new Error("Node must have idom-node-id attribute set to a non-empty string value")}if(a.match(idom.regex)){throw new Error("idom-node-id must not contain a special variable. ")}if(b.tagName.toLowerCase()=="iframe"){throw new Error("iframe is not allowed as Node. you must load and use idom from within the iframe")}if(b.children.length!=1){throw new Error("at the time of caching, node must contain just one child as Node Prototype.you may use a div to encapsulate multiple descendants.")}var h=b.getElementsByNodeType(8);if(h.length){for(var g=0;g<h.length;g++){if(h[g].textContent.match(/(@idom)([\s+])(\w+)/)&&h[g].textContent.match(/(@idom)([\s+])(\w+)/)[3]){throw new Error("Node must not have any @idom comment nodes (may only use within the Node Prototype)")}}}if(b.innerHTML.match(/(idom-node-id)/)){throw new Error("Node must not have any descendants with idom-node-id (reserved for the Node itself). you may dynamically link other Nodes by inserting <!-- @idom [the idom-node-id for node you wish to nest without the brackets] --> anywhere inside the Node Prototype")}if(b.getAttribute("id")){throw new Error("Node should not have an 'id' attribute (instead, set nodeSelector or nodeState in options and use document.querySelector with '[idom-selector=someString]' or '[idom-state=someString]')")}if(b.children[0].getAttribute("id")){throw new Error("Node Prototype should not have an 'id' attribute (instead, set ownSelector or ownState in options and use document.querySelector with '[idom-selector=someString]' or '[idom-state=someString]')")}if(b.getAttribute("idom-state")||b.getAttribute("idom-selector")){throw new Error("at time of caching, node should not have any idom-generated attributes")}if(b.innerHTML.match(/(idom-selector)/)||b.innerHTML.match(/(idom-state)/)){throw new Error("at time of caching, node's innerHTML must not contain any idom-generated attributes")}idom.internal.cache[a]=b.innerHTML}idom.internal.initDone=true};String.prototype._idomMapValues=String.prototype._idomMapValues||function(){var c=arguments[0];var b=arguments[1];var a,h;var f=idom.internal.initDone?idom.regex:idom.initRegEx;var i=idom.internal.initDone?idom.regexLength:idom.initRegexLength;try{a=JSON.stringify(c)}catch(g){h=true}if(h||a.match(/[\{]{2,}|[\[]/)){var d=new Error;d.message="Invalid data: use simple JSON: {someKey: 'value', anotherKey: 5, yetAnotherKey: 'anotherValue'}";throw d.message+"\n"+d.stack}else{if(a.match(idom.regex)){var d=new Error;d.message="Invalid data: idom node variables found in json";throw d.message+"\n"+d.stack}}if(!b){return this.replace(idom.regex,function(e){if(c[e.substr(idom.regexLength)]){return c[e.substr(idom.regexLength)]}else{return""}})}else{return this.replace(idom.initRegEx,function(e){if(c[e.substr(idom.initRegexLength)]){return c[e.substr(idom.initRegexLength)]}else{return""}})}};Element.prototype.nextSiblingElement=Element.prototype.nextSiblingElement||function(){var a=this;do{a=a.nextSibling}while(a&&a.nodeType!=1);return a};Element.prototype.previousSiblingElement=Element.prototype.previousSiblingElement||function(){var a=this;do{a=a.previousSibling}while(a&&a.nodeType!=1);return a};Element.prototype.getElementsByNodeType=Element.prototype.getElementsByNodeType||function(){var e=this;var c=arguments[0];var b=arguments[1];var f=e.childNodes;var a=[];for(var d=0;d<f.length;d++){if(f[d].nodeType==Number(c)){a.push(f[d])}if(b&&(f[d].nodeType==1)){a=a.concat(f[d].getElementsByNodeType(c,b))}}return a};idom.forEachExec=function(c,f){var b=Array.prototype.slice.call(c,0);if(!b.length){var d=new Error;d.message="object must be iterable";throw d.message+"\n"+d.stack}f=arguments[0];var a=new Function("el","el."+f);try{a(b[0])}catch(d){throw"invalid exec: "+d.message+"\n"+d.stack}for(var g=1;g<b.length;g++){a(b[g])}};Element.prototype.idom$=Element.prototype.idom$||function(){if(!idom.internal.initDone){var g=new Error;g.message="you must run idom.init() from window.onload or $(document).ready before invoking .idom$ methods";throw g.message+"\n"+g.stack}var i=this.getAttribute("idom-node-id");if(!idom.internal.cache[i]){var g=new Error;g.message="node was not cached";throw g.message+"\n"+g.stack}var p=arguments[0];var d=arguments[1];if(!(arguments[0])){var g=new Error;g.message="required argument: data (json)";throw g.message+"\n"+g.stack}if(d){var k,j;try{j=JSON.stringify(d)}catch(q){k=true}if(k||j.match(/[\{]{2,}|[\[]/)){var g=new Error;g.message="Invalid options: use simple JSON. {someKey: 'value', anotherKey: 5, yetAnotherKey: 'anotherValue'}";throw g.message+"\n"+g.stack}else{if(j.match(idom.regex)){var g=new Error;g.message="Invalid options: idom node variables found in options";throw g.message+"\n"+g.stack}}}if(this.innerHTML==idom.internal.cache[i]||!this.children.length||!d||d=={}||(d&&!(d.targetSelector||d.targetState||d.mode))){if(d){if(d.targetSelector){if(this.innerHTML==idom.internal.cache[i]||!this.children.length){var g=new Error;g.message="Invalid option: targetSelector cannot be applied: this Node currently has no populated instances of its Node Prototype";throw g.message+"\n"+g.stack}}}this.innerHTML=idom.internal.cache[i]._idomMapValues(p);if(d){c(this.children[0]);s(this)}f(this.children[0]);return}else{if(d){var h=[],r=[],t,o,b,a;if(d.targetSelector&&!d.targetState){h=this.querySelectorAll("[idom-selector="+d.targetSelector+"]");if(!h.length){var g=new Error;g.message="Invalid option: targetSelector does not match idom-selector in any instance of the Node Prototype";throw g.message+"\n"+g.stack}}else{if(!d.targetSelector&&d.targetState){h=this.querySelectorAll("[idom-state="+d.targetState+"]");if(!h.length){var g=new Error;g.message="Invalid option: targetState does not match idom-state in any instance of the Node Prototype";throw g.message+"\n"+g.stack}}else{if(d.targetSelector&&d.targetState){h=this.querySelectorAll("[idom-selector="+d.targetSelector+"][idom-state="+d.targetState+"]");if(!h.length){var g=new Error;g.message="Invalid option: 'targetSelector AND targetState' do not match idom-selector/idom-state combination in any instance of the Node Prototype";throw g.message+"\n"+g.stack}}}}if(d.targetSelector||d.targetState||d.mode=="append"||d.mode=="prepend"){t=this.children[0].tagName;o=idom.internal.cache[i]._idomMapValues(p);b=document.createElement(t);b.innerHTML=o;a=document.createDocumentFragment();a.appendChild(b.children[0])}switch(d.mode){case null:case"":case"replace":if(d.targetSelector||d.targetState){if(h.length>1){for(var m=0;m<h.length;m++){this.insertBefore(a.cloneNode(true),h[m]);r[m]=h[m].previousSiblingElement();this.removeChild(h[m]);f(r[m]);c(r[m])}}else{this.insertBefore(a.cloneNode(true),h[0]);r[0]=h[0].previousSiblingElement();this.removeChild(h[0]);f(r[0]);c(r[0])}}else{this.innerHTML=idom.internal.cache[i]._idomMapValues(p);r[0]=this.children[0];f(r[0]);c(r[0])}break;case"append":if(d.targetSelector||d.targetState){if(h.length>1){var l=h[h.length-1];this.insertBefore(a.cloneNode(true),l.nextSiblingElement());r[0]=l.nextSiblingElement();f(r[0]);c(r[0])}else{var l=h[0];this.insertBefore(a.cloneNode(true),l.nextSiblingElement());r[0]=l.nextSiblingElement();f(r[0]);c(r[0])}}else{this.appendChild(a.cloneNode(true));r[0]=this.children[this.children.length-1];f(r[0]);c(r[0])}break;case"prepend":if(d.targetSelector||d.targetState){this.insertBefore(a.cloneNode(true),h[0]);r[0]=h[0].previousSiblingElement();f(r[0]);c(r[0])}else{this.insertBefore(a.cloneNode(true),this.children[0]);r[0]=this.children[0];f(r[0]);c(r[0])}break;default:var g=new Error;g.message="invalid or misspelled value for mode";throw g.message+"\n"+g.stack}s(this);a=null}}function s(e){if(d.nodeSelector){e.setAttribute("idom-selector",d.nodeSelector)}if(d.nodeState){e.setAttribute("idom-state",d.nodeState)}}function c(e){if(d.ownSelector){e.setAttribute("idom-selector",d.ownSelector)}if(d.ownState){e.setAttribute("idom-state",d.ownState)}}function f(y){var e=y.getElementsByNodeType(8,true);var A="";if(e.length){for(var w=0;w<e.length;w++){A=e[w].textContent.match(/(@idom)([\s+])(\w+)/)?e[w].textContent.match(/(@idom)([\s+])(\w+)/)[3]:null;if(A){if(!idom.internal.cache[A]){var z=new Error;z.message="Node Prototype contains a Linked Node reference to a Node that was not cached";throw z.message+"\n"+z.stack}var u=e[w].parentNode.insertBefore(document.querySelector("[idom-node-id="+A+"]").cloneNode(true),e[w]);u.parentNode.removeChild(e[w]);u.removeAttribute("idom-node-id");var v=u.children[0].getAttribute("idom-state")||"";var B=u.children[0].getAttribute("idom-selector")||"";if(v){u.children[0].setAttribute("idom-state",v+"_linked")}if(B){u.children[0].setAttribute("idom-selector",B+"_linked")}var C=u.getAttribute("idom-state")||"";var x=u.getAttribute("idom-selector")||"";if(C){u.setAttribute("idom-state",C+"_linked")}if(x){u.setAttribute("idom-selector",x+"_linked")}}}}}};Element.prototype.idom$isPopulated=Element.prototype.idom$isPopulated||function(){if(!idom.internal.initDone){var a=new Error;a.message="you must run idom.init() from window.onload or $(document).ready before invoking .idom$ methods";throw a.message+"\n"+a.stack}var b=this.getAttribute("idom-node-id");if(!idom.internal.cache[b]){var a=new Error;a.message="node was not cached";throw a.message+"\n"+a.stack}if(this.innerHTML==idom.internal.cache[b]||!this.children.length){return false}return true};Element.prototype.idom$delete=Element.prototype.idom$delete||function(){if(!idom.internal.initDone){var f=new Error;f.message="you must run idom.init() from window.onload or $(document).ready before invoking .idom$ methods";throw f.message+"\n"+f.stack}var a=this.getAttribute("idom-node-id");if(!idom.internal.cache[a]){var f=new Error;f.message="node was not cached";throw f.message+"\n"+f.stack}if(!this.children.length){return}var j=arguments[0];var g,h;if(j){try{g=JSON.stringify(j)}catch(i){h=true}if(h||g.match(/[\{]{2,}|[\[]/)){var f=new Error;f.message="Invalid options: use simple JSON. {someKey: 'value', anotherKey: 5, yetAnotherKey: 'anotherValue'}";throw f.message+"\n"+f.stack}else{if(g.match(idom.regex)){var f=new Error;f.message="Invalid data: idom node variables found in options";throw f.message+"\n"+f.stack}}var c=[];if(j.targetSelector){if(j.targetSelector&&!j.targetState){var d=document.querySelector("[idom-node-id="+a+"]");for(var b=0;b<d.children.length;b++){if(d.children[b].getAttribute("idom-selector")==j.targetSelector){c.push(d.children[b])}}if(!c){var f=new Error;f.message="Invalid option: targetSelector does not match idom-selector in any instance of the Node Prototype";throw f.message+"\n"+f.stack}}else{if(!j.targetSelector&&j.targetState){var d=document.querySelector("[idom-node-id="+a+"]");for(var b=0;b<d.children.length;b++){if(d.children[b].getAttribute("idom-state")==j.targetState){c.push(d.children[b])}}if(!c){var f=new Error;f.message="Invalid option: targetSelector does not match idom-selector in any instance of the Node Prototype)";throw f.message+"\n"+f.stack}}else{if(j.targetSelector&&j.targetState){var d=document.querySelector("[idom-node-id="+a+"]");for(var b=0;b<d.children.length;b++){if(d.children[b].getAttribute("idom-state")==j.targetState&&d.children[b].getAttribute("idom-selector")==j.targetSelector){c.push(d.children[b])}}if(!c){var f=new Error;f.message="Invalid option: targetSelector does not match idom-selector in any instance of the Node Prototypee";throw f.message+"\n"+f.stack}}}}for(var b=0;b<c.length;b++){this.removeChild(c[b])}}if(j.nodeState){this.setAttribute("idom-state",j.nodeState)}if(j.nodeSelector){this.setAttribute("idom-selector",j.nodeSelector)}}else{this.innerHTML=""}};if(typeof(jQuery)=="function"){(function(a){a.fn.idom$=function(){var b=this.get(0)};a.fn.idom$isPopulated=function(){var b=this.get(0)};a.fn.idom$delete=function(){var b=this.get(0)}})(jQuery)};