/* natty.js -- NiNu's Anti-Templating 

Copyright (c) Marc Fawzi, NiNu, Inc. 2011

BSD License 

*/
var Natty={};Natty.user={};Natty.version="0.08";Natty.regex=/(n\$\w+)/g;Natty.regexLength=2;Natty.presetRegEx=/(i\$\w+)/g;Natty.initRegexLength=2;Natty.internal={};Natty.internal.cache={};Natty.init=function(c){if(Natty.internal.initDone){return}if(!Element||!NodeList||!String){var f=new Error;f.message="This browser is not supported: some basic Javascript objects are missing";throw f.message+"\n"+f.stack}if(c){document.documentElement.innerHTML=document.documentElement.innerHTML._nattyMapValues(c,true)}var b=document.querySelectorAll("[natty-node-id]");var e=Array.prototype.slice.call(b,0);b=null;for(var h=0;h<e.length;h++){var d=e[h];var g=d.getAttribute("natty-node-id");if(Natty.internal.cache[g]){throw new Error("natty-node-id is in use by another Node")}if(!g){throw new Error("Node must have natty-node-id attribute set to a non-empty string value")}if(g.match(Natty.regex)){throw new Error("natty-node-id must not contain a special variable. ")}if(d.tagName.toLowerCase()=="iframe"){throw new Error("iframe is not allowed as Node. you must load and use natty from within the iframe")}if(d.children.length!=1){throw new Error("at the time of caching, node must contain just one child as Node Prototype.you may use a div to encapsulate multiple descendants.")}var a=d.getElementsByNodeType(8);if(a.length){for(var h=0;h<a.length;h++){if(a[i].textContent.match(/(@natty)([\s+])(\w+)/)[3]){throw new Error("Node must not have any @natty comment nodes (may only use within the Node Prototype)")}}}if(d.innerHTML.match(/(natty-node-id)/)){throw new Error("Node must not have any descendants with natty-node-id (reserved for the Node itself). you may dynamically link other Nodes by inserting <!-- @natty [the natty-node-id for node you wish to nest without the brackets] --> anywhere inside the Node Prototype")}if(d.getAttribute("id")){throw new Error("Node should not have an 'id' attribute (instead, set nodeSelector or nodeState in options and use document.querySelector with '[natty-selector=someString]' or '[natty-state=someString]')")}if(d.children[0].getAttribute("id")){throw new Error("Node Prototype should not have an 'id' attribute (instead, set ownSelector or ownState in options and use document.querySelector with '[natty-selector=someString]' or '[natty-state=someString]')")}if(d.getAttribute("natty-state")||d.getAttribute("natty-selector")){throw new Error("at time of caching, node should not have any natty-generated attributes")}if(d.innerHTML.match(/(natty-selector)/)||d.innerHTML.match(/(natty-state)/)){throw new Error("at time of caching, node's innerHTML must not contain any natty-generated attributes")}Natty.internal.cache[g]=d.innerHTML}Natty.internal.initDone=true};String.prototype._nattyMapValues=String.prototype._nattyMapValues||function(){var c=arguments[0];var b=arguments[1];var a,h;var f=Natty.internal.initDone?Natty.regex:Natty.presetRegEx;var j=Natty.internal.initDone?Natty.regexLength:Natty.initRegexLength;try{a=JSON.stringify(c)}catch(g){h=true}if(h||a.match(/[\{]{2,}|[\[]/)){var d=new Error;d.message="Invalid data: use simple JSON: {someKey: 'value', anotherKey: 5, yetAnotherKey: 'anotherValue'}";throw d.message+"\n"+d.stack}else{if(a.match(Natty.regex)){var d=new Error;d.message="Invalid data: natty node variables found in json";throw d.message+"\n"+d.stack}}if(!b){return this.replace(Natty.regex,function(e){if(c[e.substr(Natty.regexLength)]){return c[e.substr(Natty.regexLength)]}else{return""}})}else{return this.replace(Natty.presetRegEx,function(e){if(c[e.substr(Natty.initRegexLength)]){return c[e.substr(Natty.initRegexLength)]}else{return""}})}};Element.prototype.nextSiblingElement=Element.prototype.nextSiblingElement||function(){var a=this;do{a=a.nextSibling}while(a&&a.nodeType!=1);return a};Element.prototype.previousSiblingElement=Element.prototype.previousSiblingElement||function(){var a=this;do{a=a.previousSibling}while(a&&a.nodeType!=1);return a};Element.prototype.getElementsByNodeType=Element.prototype.getElementsByNodeType||function(){var e=this;var c=arguments[0];var b=arguments[1];var f=e.childNodes;var a=[];for(var d=0;d<f.length;d++){if(f[d].nodeType==Number(c)){a.push(f[d])}if(b&&(f[d].nodeType==1)){a=a.concat(f[d].getElementsByNodeType(c,b))}}return a};Object.prototype.forEachExec=Object.prototype.forEachExec||function(){var b=Array.prototype.slice.call(this,0);if(!b.length){var c=new Error;c.message="object must be indexable";throw c.message+"\n"+c.stack}str=arguments[0];var a=new Function("el","el."+str);try{a(b[0])}catch(c){throw"invalid exec: "+c.message+"\n"+c.stack}for(var d=1;d<b.length;d++){a(b[d])}};Element.prototype.n$=Element.prototype.n$||function(){if(!Natty.internal.initDone){var g=new Error;g.message="you must run Natty.init() from window.onload or $(document).ready before invoking .n$ methods";throw g.message+"\n"+g.stack}var j=this.getAttribute("natty-node-id");if(!Natty.internal.cache[j]){var g=new Error;g.message="node was not cached";throw g.message+"\n"+g.stack}var q=arguments[0];var d=arguments[1];if(!(arguments[0])){var g=new Error;g.message="required argument: data (json)";throw g.message+"\n"+g.stack}if(d){var l,k;try{k=JSON.stringify(d)}catch(r){l=true}if(l||k.match(/[\{]{2,}|[\[]/)){var g=new Error;g.message="Invalid options: use simple JSON. {someKey: 'value', anotherKey: 5, yetAnotherKey: 'anotherValue'}";throw g.message+"\n"+g.stack}else{if(k.match(Natty.regex)){var g=new Error;g.message="Invalid options: natty node variables found in options";throw g.message+"\n"+g.stack}}}if(this.innerHTML==Natty.internal.cache[j]||!this.children||!d||d=={}||(d&&!(d.targetSelector||d.targetState||d.mode))){if(d){if(d.targetSelector){if(this.innerHTML==Natty.internal.cache[j]||!this.children){var g=new Error;g.message="Invalid option: targetSelector cannot be applied: this Node currently has no populated instances of its Node Prototype";throw g.message+"\n"+g.stack}}}this.innerHTML=Natty.internal.cache[j]._nattyMapValues(q);if(d){c(this.children[0]);t(this)}f(this.children[0]);return}else{if(d){var h=[],s=[],u,p,b,a;if(d.targetSelector&&!d.targetState){h=this.querySelectorAll("[natty-selector="+d.targetSelector+"]");if(!h.length){var g=new Error;g.message="Invalid option: targetSelector does not match natty-selector in any instance of the Node Prototype";throw g.message+"\n"+g.stack}}else{if(!d.targetSelector&&d.targetState){h=this.querySelectorAll("[natty-state="+d.targetState+"]");if(!h.length){var g=new Error;g.message="Invalid option: targetState does not match natty-state in any instance of the Node Prototype";throw g.message+"\n"+g.stack}}else{if(d.targetSelector&&d.targetState){h=this.querySelectorAll("[natty-selector="+d.targetSelector+"][natty-state="+d.targetState+"]");if(!h.length){var g=new Error;g.message="Invalid option: 'targetSelector AND targetState' do not match natty-selector/natty-state combination in any instance of the Node Prototype";throw g.message+"\n"+g.stack}}}}if(d.targetSelector||d.targetState||d.mode=="append"||d.mode=="prepend"){u=this.children[0].tagName;p=Natty.internal.cache[j]._nattyMapValues(q);b=document.createElement(u);b.innerHTML=p;a=document.createDocumentFragment();a.appendChild(b.children[0])}switch(d.mode){case null:case"":case"replace":if(d.targetSelector||d.targetState){if(h.length>1){for(var o=0;o<h.length;o++){this.insertBefore(a.cloneNode(true),h[o]);s[o]=h[o].previousSiblingElement();this.removeChild(h[o]);f(s[o]);c(s[o])}}else{this.insertBefore(a.cloneNode(true),h[0]);s[0]=h[0].previousSiblingElement();this.removeChild(h[0]);f(s[0]);c(s[0])}}else{this.innerHTML=Natty.internal.cache[j]._nattyMapValues(q);s[0]=this.children[0];f(s[0]);c(s[0])}break;case"append":if(d.targetSelector||d.targetState){if(h.length>1){var m=h[h.length-1];this.insertBefore(a.cloneNode(true),m.nextSiblingElement());s[0]=m.nextSiblingElement();f(s[0]);c(s[0])}else{var m=h[0];this.insertBefore(a.cloneNode(true),m.nextSiblingElement());s[0]=m.nextSiblingElement();f(s[0]);c(s[0])}}else{this.appendChild(a.cloneNode(true));s[0]=this.children[this.children.length-1];f(s[0]);c(s[0])}break;case"prepend":if(d.targetSelector||d.targetState){this.insertBefore(a.cloneNode(true),h[0]);s[0]=h[0].previousSiblingElement();f(s[0]);c(s[0])}else{this.insertBefore(a.cloneNode(true),this.children[0]);s[0]=this.children[0];f(s[0]);c(s[0])}break;default:var g=new Error;g.message="invalid or misspelled value for mode";throw g.message+"\n"+g.stack}t(this);a=null}}function t(e){if(d.nodeSelector){e.setAttribute("natty-selector",d.nodeSelector)}if(d.nodeState){e.setAttribute("natty-state",d.nodeState)}}function c(e){if(d.ownSelector){e.setAttribute("natty-selector",d.ownSelector)}if(d.ownState){e.setAttribute("natty-state",d.ownState)}}function f(z){var e=z.getElementsByNodeType(8,true);var B="";if(e.length){for(var x=0;x<e.length;x++){B=e[x].textContent.match(/(@natty)([\s+])(\w+)/)[3];if(B){if(!Natty.internal.cache[B]){var A=new Error;A.message="Node Prototype contains a Linked Node reference to a Node that was not cached";throw A.message+"\n"+A.stack}}var v=e[x].parentNode.insertBefore(document.querySelector("[natty-node-id="+B+"]").cloneNode(true),e[x]);v.parentNode.removeChild(e[x]);v.removeAttribute("natty-node-id");var w=v.children[0].getAttribute("natty-state")||"";var C=v.children[0].getAttribute("natty-selector")||"";if(w){v.children[0].setAttribute("natty-state",w+"_linked")}if(C){v.children[0].setAttribute("natty-selector",C+"_linked")}var D=v.getAttribute("natty-state")||"";var y=v.getAttribute("natty-selector")||"";if(D){v.setAttribute("natty-state",D+"_linked")}if(y){v.setAttribute("natty-selector",y+"_linked")}}}}};Element.prototype.n$isPopulated=Element.prototype.n$isPopulated||function(){if(!Natty.internal.initDone){var a=new Error;a.message="you must run Natty.init() from window.onload or $(document).ready before invoking .n$ methods";throw a.message+"\n"+a.stack}var b=this.getAttribute("natty-node-id");if(!Natty.internal.cache[b]){var a=new Error;a.message="node was not cached";throw a.message+"\n"+a.stack}if(this.innerHTML==Natty.internal.cache[b]||!this.children){return false}return true};Element.prototype.n$delete=Element.prototype.n$delete||function(){if(!Natty.internal.initDone){var f=new Error;f.message="you must run Natty.init() from window.onload or $(document).ready before invoking .n$ methods";throw f.message+"\n"+f.stack}var a=this.getAttribute("natty-node-id");if(!Natty.internal.cache[a]){var f=new Error;f.message="node was not cached";throw f.message+"\n"+f.stack}if(!this.children){return}var k=arguments[0];var g,h;if(k){try{g=JSON.stringify(k)}catch(j){h=true}if(h||g.match(/[\{]{2,}|[\[]/)){var f=new Error;f.message="Invalid options: use simple JSON. {someKey: 'value', anotherKey: 5, yetAnotherKey: 'anotherValue'}";throw f.message+"\n"+f.stack}else{if(g.match(Natty.regex)){var f=new Error;f.message="Invalid data: natty node variables found in options";throw f.message+"\n"+f.stack}}var c=[];if(k.targetSelector){if(k.targetSelector&&!k.targetState){var d=document.querySelector("[natty-node-id="+a+"]");for(var b=0;b<d.children.length;b++){if(d.children[b].getAttribute("natty-selector")==k.targetSelector){c.push(d.children[b])}}if(!c){var f=new Error;f.message="Invalid option: targetSelector does not match natty-selector in any instance of the Node Prototype";throw f.message+"\n"+f.stack}}else{if(!k.targetSelector&&k.targetState){var d=document.querySelector("[natty-node-id="+a+"]");for(var b=0;b<d.children.length;b++){if(d.children[b].getAttribute("natty-state")==k.targetState){c.push(d.children[b])}}if(!c){var f=new Error;f.message="Invalid option: targetSelector does not match natty-selector in any instance of the Node Prototype)";throw f.message+"\n"+f.stack}}else{if(k.targetSelector&&k.targetState){var d=document.querySelector("[natty-node-id="+a+"]");for(var b=0;b<d.children.length;b++){if(d.children[b].getAttribute("natty-state")==k.targetState&&d.children[b].getAttribute("natty-selector")==k.targetSelector){c.push(d.children[b])}}if(!c){var f=new Error;f.message="Invalid option: targetSelector does not match natty-selector in any instance of the Node Prototypee";throw f.message+"\n"+f.stack}}}}for(var b=0;b<c.length;b++){this.removeChild(c[b])}}if(k.nodeState){this.setAttribute("natty-state",k.nodeState)}if(k.nodeSelector){this.setAttribute("natty-selector",k.nodeSelector)}}else{this.innerHTML=""}};if(typeof(jQuery)=="function"){(function(a){a.fn.n$=function(){var b=this.get(0)};a.fn.n$isPopulated=function(){var b=this.get(0)};a.fn.n$delete=function(){var b=this.get(0)}})(jQuery)};